<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Color Mixing App</title>
  <style>
    :root {
      --bg-color: rgb(46, 46, 46);  /* 18% grey */
      --surface-color: rgb(66, 66, 66);
      --accent-color: rgb(86, 86, 86);
      --text-color: white;
      --border-color: rgb(86, 86, 86);
      --shadow-color: rgba(0, 0, 0, 0.2);
    }

    body {
      font-family: sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      background-color: var(--bg-color);
      color: var(--text-color);
      min-height: 100vh;
      margin: 0;
      padding: 20px;
    }

    .color-box {
      width: 200px;
      height: 200px;
      margin: 10px;
      border: 2px solid var(--border-color);
      background-color: var(--surface-color);
    }

    #palette {
      display: flex;
      gap: 15px;
      margin-top: 30px;
    }

    .color-circle {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      justify-content: center;
      align-items: center;
      color: var(--text-color);
      font-weight: bold;
      font-size: 1.2em;
      box-shadow: 0 2px 8px var(--shadow-color);
    }

    #stats {
      margin-top: 20px;
      background-color: var(--surface-color);
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 8px var(--shadow-color);
    }

    .color-control {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .minus-button {
      margin-top: 6px;
      font-size: 18px;
      padding: 0 8px;
      border: none;
      background: var(--accent-color);
      color: var(--text-color);
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 2px 4px var(--shadow-color);
    }

    .minus-button:hover {
      background: var(--surface-color);
    }

    .color-comparison-container {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 20px;
    }

    .color-window {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .color-label {
      font-weight: bold;
      margin-bottom: 12px;
      font-size: 1.2em;
    }

    .color-divider {
      width: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .match-percentage {
      background: var(--surface-color);
      color: var(--text-color);
      padding: 0.8em 1.5em;
      border-radius: 1em;
      font-weight: bold;
      border: 1px solid var(--border-color);
      box-shadow: 0 2px 8px var(--shadow-color);
      font-size: 1.1em;
    }

    .color-pair {
      display: flex;
      width: 600px;
      height: 300px;
      border: 2px solid var(--border-color);
      border-radius: 8px;
      overflow: hidden;
      margin-bottom: 16px;
      box-shadow: 0 4px 12px var(--shadow-color);
    }

    .color-half {
      flex: 1;
      height: 100%;
    }

    #controls {
      margin-top: 20px;
    }

    #controls button {
      background: var(--accent-color);
      color: var(--text-color);
      border: none;
      padding: 8px 16px;
      margin: 0 4px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1em;
      box-shadow: 0 2px 4px var(--shadow-color);
    }

    #controls button:hover {
      background: var(--surface-color);
    }

    #controls button:disabled {
      background: var(--bg-color);
      cursor: not-allowed;
    }

    #timer {
      font-size: 1.2em;
      font-weight: bold;
    }

    .button-tooltip {
      position: relative;
      display: inline-block;
    }

    .button-tooltip .tooltip-text {
      visibility: hidden;
      width: 200px;
      background-color: var(--surface-color);
      color: var(--text-color);
      text-align: center;
      border-radius: 6px;
      padding: 10px;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      transform: translateX(-50%);
      opacity: 0;
      transition: opacity 0.3s;
      box-shadow: 0 2px 8px var(--shadow-color);
      pointer-events: none;
    }

    .button-tooltip .tooltip-text::after {
      content: "";
      position: absolute;
      top: 100%;
      left: 50%;
      margin-left: -5px;
      border-width: 5px;
      border-style: solid;
      border-color: var(--surface-color) transparent transparent transparent;
    }

    .button-tooltip:hover .tooltip-text {
      visibility: visible;
      opacity: 1;
    }

    .spectral-mixer-btn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: var(--accent-color);
      color: var(--text-color);
      border: none;
      padding: 12px 24px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1.1em;
      text-decoration: none;
      box-shadow: 0 2px 8px var(--shadow-color);
    }

    .spectral-mixer-btn:hover {
      background: var(--surface-color);
    }

    /* Modal styles */
    #userModal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal-content {
      background: var(--surface-color);
      padding: 2em;
      border-radius: 10px;
      max-width: 90vw;
      min-width: 300px;
      color: var(--text-color);
      box-shadow: 0 4px 12px var(--shadow-color);
    }

    .modal-content h2 {
      margin-top: 0;
      color: var(--text-color);
    }

    .modal-content input,
    .modal-content select {
      background: var(--bg-color);
      border: 1px solid var(--border-color);
      color: var(--text-color);
      padding: 8px;
      border-radius: 4px;
      width: 100%;
      margin-top: 5px;
    }

    .modal-content button {
      background: var(--accent-color);
      color: var(--text-color);
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 10px;
    }

    .modal-content button:hover {
      background: var(--surface-color);
    }

    .modal-content hr {
      border: none;
      border-top: 1px solid var(--border-color);
      margin: 20px 0;
    }

    #generatedId {
      font-family: monospace;
      letter-spacing: 2px;
      text-align: center;
      color: var(--text-color);
    }

    .rgb-values {
      margin-top: 10px;
      font-family: monospace;
      font-size: 0.9em;
      color: var(--text-color);
      text-align: center;
    }
  </style>

  <!-- ✅ Load Mixbox for perceptual mixing -->
  <script src="{{ url_for('static', filename='mixbox.js') }}"></script>

  <!-- ✅ Load your app's logic -->
  <script type="module" src="{{ url_for('static', filename='main.js') }}"></script>
</head>
<body>
  <div id="userModal">
    <div class="modal-content">
      <div id="registerSection">
        <h2>Welcome!</h2>
        <p>Please enter your birthdate and gender to get started.</p>
        <form id="registerForm">
          <label>Birthdate: <input type="date" id="userBirthdate" required></label><br><br>
          <label>Gender:
            <select id="userGender" required>
              <option value="">Select…</option>
              <option value="female">Female</option>
              <option value="male">Male</option>
              <option value="other">Other</option>
              <option value="prefer_not_to_say">Prefer not to say</option>
            </select>
          </label><br><br>
          <button type="submit">Continue to Color Vision Test</button>
        </form>
        <hr>
        <p>Already have an ID? <button id="showLoginBtn" type="button">Log in</button></p>
      </div>

      <div id="colorTestSection" style="display:none;">
        <h2>Color Vision Test</h2>
        <p>Please identify the number you see in the circle below:</p>
        <div id="ishiharaPlate" style="width: 300px; height: 300px; margin: 20px auto; border-radius: 50%; background: #f0f0f0; position: relative; overflow: hidden;">
          <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 120px; font-weight: bold; color: #ff0000;">7</div>
          <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: repeating-radial-gradient(circle at 50% 50%, #00ff00 0%, #00ff00 2%, transparent 2%, transparent 4%);"></div>
        </div>
        <div style="text-align: center;">
          <input type="number" id="testAnswer" min="1" max="99" placeholder="Enter the number you see" required>
          <button id="submitTest">Submit Answer</button>
        </div>
        <p id="testResult" style="text-align: center; margin-top: 10px;"></p>
      </div>

      <div id="loginSection" style="display:none;">
        <h2>Log in</h2>
        <form id="loginForm">
          <label>Your 6-character ID: <input type="text" id="loginId" maxlength="6" minlength="6" required style="text-transform:uppercase"></label><br><br>
          <button type="submit">Log in</button>
        </form>
        <hr>
        <p>New user? <button id="showRegisterBtn" type="button">Register</button></p>
      </div>
      <div id="idDisplaySection" style="display:none;">
        <h2>Your ID</h2>
        <p style="font-size:2em;font-weight:bold;" id="generatedId"></p>
        <p>Please memorize this ID. You will need it to log in next time.</p>
        <button id="continueBtn">Continue</button>
      </div>
    </div>
  </div>

  <h1>Color Mixing App</h1>

  <div style="max-width: 800px; margin: 20px auto; padding: 20px; background-color: var(--surface-color); border-radius: 8px; box-shadow: 0 2px 8px var(--shadow-color);">
    <h2 style="margin-top: 0;">Kedves Kollégák!</h2>
    <p style="line-height: 1.6;">
      Szeretném, ha egy kicsit nyomkodnátok, használnátok a színkeverős webalkalmazásunkat. 
      A célunk az vele, hogy megismerjük a "laikusok" színkeverő teljesítményét a bőrszínek színterében. 
      Ha bármi hibaüzenetet tapasztaltok, 
      kérlek jelezzétek nekem <a href="mailto:konig.janos@semmelweis.hu">e-mailben</a> "SHADEMATCH" tárggyal. Köszönjük!
    </p>
    <p style="margin-bottom: 0;">
      König János<br>
      Labancz Laura
    </p>
  </div>

  <div style="display: flex; gap: 20px; max-width: 1200px; margin: 20px auto; padding: 0 20px;">
    <!-- Main Content -->
    <div style="flex: 1;">
      <div class="color-pair">
        <div id="targetColor" class="color-half"></div>
        <div id="currentMix" class="color-half"></div>
      </div>
      <div style="margin-top: 8px; font-weight: bold;">
        ΔE (CIEDE2000): <span id="deltaE">-</span>
      </div>
      <div style="margin-top: 4px; font-family: monospace; font-size: 0.9em; text-align: right; padding-right: 150px;">
        <span id="mixedRgbValues">RGB: [255, 255, 255]</span>
      </div>

      <div id="palette">
        <div class="color-control">
            <div class="color-circle" data-color="white" style="background: white; color: black;">0</div>
            <button class="minus-button" data-color="white">−</button>
          </div>
        <div class="color-control">
            <div class="color-circle" data-color="black" style="background: black;">0</div>
            <button class="minus-button" data-color="black">−</button>
          </div>
        <div class="color-control">
            <div class="color-circle" data-color="red" style="background: red;">0</div>
            <button class="minus-button" data-color="red">−</button>
          </div>
        <div class="color-control">
            <div class="color-circle" data-color="yellow" style="background: yellow; color: black;">0</div>
            <button class="minus-button" data-color="yellow">−</button>
          </div>
        <div class="color-control">
            <div class="color-circle" data-color="blue" style="background: blue;">0</div>
            <button class="minus-button" data-color="blue">−</button>
          </div>
      </div>

      <div id="stats">
      </div>
      <div id="controls" style="margin-top: 20px;">
        <div class="button-tooltip">
          <button id="startBtn">Start</button>
          <span class="tooltip-text">Push this to start the game</span>
        </div>
        <button id="stopBtn" disabled>Stop</button>
        <div class="button-tooltip">
          <button id="skipBtn" disabled>Skip</button>
          <span class="tooltip-text">Push the button to proceed to the next color</span>
        </div>
        <button id="restartBtn" disabled>Restart</button>
        <button id="retryBtn" disabled>Retry</button>
        <button id="switchUserBtn">Switch User</button>
      </div>
      <p>⏱️ Time: <span id="timer">0.0</span> sec</p>
    </div>

    <!-- Color Relationships Sidebar -->
    <div style="width: 400px; flex-shrink: 0;">
      <div style="background-color: var(--surface-color); padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px var(--shadow-color);">
        <h2 style="margin-top: 0; text-align: center;">Color Relationships</h2>
        <div style="position: relative; width: 300px; height: 320px; margin: 0 auto;">
          <!-- Complementary Lines -->
          <svg style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;">
            <!-- Red-Green -->
            <line x1="150" y1="38" x2="150" y2="238" stroke="white" stroke-width="2" stroke-dasharray="6,6" />
            <!-- Orange-Blue -->
            <line x1="53" y1="73" x2="247" y2="173" stroke="white" stroke-width="2" stroke-dasharray="6,6" />
            <!-- Yellow-Purple -->
            <line x1="53" y1="173" x2="247" y2="73" stroke="white" stroke-width="2" stroke-dasharray="6,6" />
          </svg>
          <!-- Hexagon Corners (Primary and Secondary Colors) -->
          <!-- Top: Red (150,38) -->
          <div style="position: absolute; left: 50%; top: 20px; transform: translateX(-50%); width: 36px; height: 36px; border-radius: 50%; background: red; border: 3px solid white; box-shadow: 0 0 10px rgba(0,0,0,0.3);"></div>
          <!-- Top right: Purple (247,73) -->
          <div style="position: absolute; left: 225px; top: 55px; width: 36px; height: 36px; border-radius: 50%; background: purple; border: 3px solid white; box-shadow: 0 0 10px rgba(0,0,0,0.3);"></div>
          <!-- Bottom right: Blue (247,173) -->
          <div style="position: absolute; left: 225px; top: 155px; width: 36px; height: 36px; border-radius: 50%; background: blue; border: 3px solid white; box-shadow: 0 0 10px rgba(0,0,0,0.3);"></div>
          <!-- Bottom: Green (150,238) -->
          <div style="position: absolute; left: 50%; top: 220px; transform: translateX(-50%); width: 36px; height: 36px; border-radius: 50%; background: green; border: 3px solid white; box-shadow: 0 0 10px rgba(0,0,0,0.3);"></div>
          <!-- Bottom left: Yellow (53,173) -->
          <div style="position: absolute; left: 35px; top: 155px; width: 36px; height: 36px; border-radius: 50%; background: yellow; border: 3px solid white; box-shadow: 0 0 10px rgba(0,0,0,0.3);"></div>
          <!-- Top left: Orange (53,73) -->
          <div style="position: absolute; left: 35px; top: 55px; width: 36px; height: 36px; border-radius: 50%; background: orange; border: 3px solid white; box-shadow: 0 0 10px rgba(0,0,0,0.3);"></div>
          
          <!-- Labels -->
          <div style="position: absolute; top: -18px; left: 50%; transform: translateX(-50%); color: white; font-weight: bold;">Red</div>
          <div style="position: absolute; top: 35px; left: 0px; color: white; font-weight: bold;">Orange</div>
          <div style="position: absolute; top: 35px; right: 0px; color: white; font-weight: bold;">Purple</div>
          <div style="position: absolute; top: 185px; left: 0px; color: white; font-weight: bold;">Yellow</div>
          <div style="position: absolute; top: 185px; right: 0px; color: white; font-weight: bold;">Blue</div>
          <div style="position: absolute; top: 260px; left: 50%; transform: translateX(-50%); color: white; font-weight: bold;">Green</div>
        </div>
        <div style="margin-top: 20px; color: var(--text-color); text-align: center;">
          <p>Primary Colors: Red, Yellow, Blue</p>
          <p>Secondary Colors: Orange (R+Y), Green (Y+B), Purple (R+B)</p>
          <p><em>Mixing complementary colors would result in grey (saturation is lowered).</em></p>
        </div>
      </div>
    </div>
  </div>

  <a href="/spectral" class="spectral-mixer-btn">A 2.0 verzióhoz (Spectral Mixer) →</a>

  <script>
  function generateId() {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    let id = '';
    for (let i = 0; i < 6; i++) {
      id += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return id;
  }

  function showSection(section) {
    document.getElementById('registerSection').style.display = section === 'register' ? '' : 'none';
    document.getElementById('loginSection').style.display = section === 'login' ? '' : 'none';
    document.getElementById('idDisplaySection').style.display = section === 'idDisplay' ? '' : 'none';
    document.getElementById('colorTestSection').style.display = section === 'colorTest' ? 'none' : 'none';
  }

  function showUserModal() {
    const modal = document.getElementById('userModal');
    modal.style.display = 'flex';
    showSection('login');
  }

  window.addEventListener('DOMContentLoaded', () => {
    const modal = document.getElementById('userModal');
    const storedId = localStorage.getItem('userId');
    const storedBirthdate = localStorage.getItem('userBirthdate');
    const storedGender = localStorage.getItem('userGender');
    
    // Clear any incomplete registration data
    if (storedBirthdate && storedGender && !storedId) {
      localStorage.removeItem('userBirthdate');
      localStorage.removeItem('userGender');
    }
    
    if (storedId) {
      modal.style.display = 'none';
    } else {
      modal.style.display = 'flex';
      showSection('register');
    }

    // Add click event listener to close modal when clicking outside
    modal.addEventListener('click', function(e) {
      if (e.target === modal) {
        modal.style.display = 'none';
      }
    });

    document.getElementById('switchUserBtn').onclick = function() {
      showUserModal();
    };

    document.getElementById('continueBtn').onclick = function() {
      document.getElementById('userModal').style.display = 'none';
    };

    document.getElementById('showLoginBtn').onclick = function() {
      showSection('login');
    };
    document.getElementById('showRegisterBtn').onclick = function() {
      showSection('register');
    };

    document.getElementById('registerForm').onsubmit = function(e) {
      e.preventDefault();
      const birthdate = document.getElementById('userBirthdate').value;
      const gender = document.getElementById('userGender').value;
      localStorage.setItem('userBirthdate', birthdate);
      localStorage.setItem('userGender', gender);
      // Redirect to the color test page
      window.location.href = '/color-test';
    };

    document.getElementById('loginForm').onsubmit = function(e) {
      e.preventDefault();
      const id = document.getElementById('loginId').value.toUpperCase();
      if (id.length === 6) {
        localStorage.setItem('userId', id);
        document.getElementById('userModal').style.display = 'none';
      }
    };

    // Initialize the mixed color display
    calculateMixedColor();
  });

  // Optional: Add a "Log out" button somewhere in your app to clear the ID
  function logoutUser() {
    localStorage.removeItem('userId');
    localStorage.removeItem('userBirthdate');
    localStorage.removeItem('userGender');
    location.reload();
  }

  // Function to calculate mixed color
  function calculateMixedColor() {
    const colors = {
      white: [255, 255, 255],
      black: [0, 0, 0],
      red: [255, 0, 0],
      yellow: [255, 255, 0],
      blue: [0, 0, 255]
    };
    
    let totalDrops = 0;
    let mixedColor = [0, 0, 0];
    
    // Calculate total drops and weighted color
    Object.keys(colors).forEach(color => {
      const drops = parseInt(document.querySelector(`[data-color="${color}"]`).textContent);
      totalDrops += drops;
      mixedColor = mixedColor.map((val, i) => val + (colors[color][i] * drops));
    });
    
    // Normalize the color if there are any drops
    if (totalDrops > 0) {
      mixedColor = mixedColor.map(val => Math.round(val / totalDrops));
    } else {
      mixedColor = [255, 255, 255]; // Default to white if no drops
    }
    
    // Update the mixed color display
    const currentMix = document.getElementById('currentMix');
    currentMix.style.backgroundColor = `rgb(${mixedColor.join(',')})`;
    
    // Update RGB values display
    document.getElementById('mixedRgbValues').textContent = `RGB: [${mixedColor.join(', ')}]`;
    
    return mixedColor;
  }
  </script>

</body>
</html>